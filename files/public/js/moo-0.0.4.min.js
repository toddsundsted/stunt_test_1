if(!window.Moo&&!document.Moo){Moo={}}(function(a){function c(g,h){return g.indexOf(h,g.length-h.length)!==-1}a.formatHTML=function(i,h){if(_.isNumber(i)){return'<span class="moo-num">'+i+"</span>"}else{if(_.isString(i)){var j,g;if(c(i,"|err")){j=_.escape(i.slice(0,i.length-4));return'<span class="moo-err">'+j+"</span>"}else{if(c(i,"|obj")){j=_.escape(i.slice(0,i.length-4));g=_.escape(i.slice(0,i.length-4).slice(1));return'<a rel="object" data-object-number="'+g+'" class="moo-obj" href="/objects/'+g+'">'+j+"</a>"}else{if(c(i,"|int")){j=_.escape(i.slice(0,i.length-4));return'<span class="moo-num">'+j+"</span>"}else{if(c(i,"|float")){j=_.escape(i.slice(0,i.length-6));return'<span class="moo-num">'+j+"</span>"}else{if(c(i,"|str")){j=i.slice(0,i.length-4);return'<span class="moo-str">'+_.escape(h?'"'+j.replace(/"/gm,'\\"')+'"':j)+"</span>"}else{j=i;return'<span class="moo-str">'+_.escape(h?'"'+j.replace(/"/gm,'\\"')+'"':j)+"</span>"}}}}}}else{if(_.isArray(i)){return'<span class="moo-list">{ '+_.map(i,function(k){return a.formatHTML(k,true)}).join(", ")+" }</span>"}else{if(_.isObject(i)){return'<span class="moo-map">[ '+_.map(i,function(m,l){return a.formatHTML(l,true)+" -> "+a.formatHTML(m,true)}).join(", ")+" ]</span>"}}}}};_.extend(a,{isString:function(g){return typeof(g)=="string"&&!(c(g,"|obj")||c(g,"|err"))},isObjectNumber:function(g){return typeof(g)=="string"&&c(g,"|obj")},isError:function(g){return typeof(g)=="string"&&c(g,"|err")},isBinary:function(g){return g===0||g===1},isValidPerms:function(g,h){return typeof(g)=="string"&&g.match("^["+h+"]*$")},isValidObj:function(g){return _.include(["this","none","any"],g)},isValidPrep:function(h){var g=["with","using","at","to","in front of","in","inside","into","on top of","on","onto","upon","out of","from inside","from","over","through","under","underneath","beneath","behind","beside","for","about","is","as","off","off of","none","any"];return _.include(g,h)},isValidCode:function(g){return _.isArray(g)&&_.all(g,a.isString)},isValidObjectNumberArray:function(g){return _.isArray(g)&&_.all(g,a.isObjectNumber)}});a.NestedModel=Backbone.Model.extend({initialize:function(g){},has:function(h){var g=this.get(h);return !(g===null||g===undefined)},get:function(g,i){i=i||{};var k=g.split("."),h=k.shift();var j=Backbone.Model.prototype.get.call(this,h,i);_.each(k,function(l){j=j!=undefined&&(l in j)?j[l]:undefined});return j},set:function(i,k,j){var h;if(_.isObject(i)){h=i;j=k}else{h={};h[i]=k}j=j||{};var g=_.inject(this.attributes,function(l,n,m){l[m]=_.clone(n);return l},{});_.each(h,function(o,l){var q=l.split("."),m=q.shift();var p=g,n=m;_.each(q,function(r){if(!(n in p)){p[n]={}}p=p[n];n=r});p[n]=o});return Backbone.Model.prototype.set.call(this,g,j)}});a.Attribute=a.NestedModel.extend({validate:function(g){if(g&&"Value" in g&&(typeof(g.Value)!="object")){return"invalid attribute"}}});a.Value=a.NestedModel.extend({validate:function(g){if(g&&"Value" in g&&(typeof(g.Value)!="object")){return"invalid value"}if(g&&"Value" in g&&"clear" in g.Value&&!a.isBinary(g.Value.clear)){return"invalid value: `clear' must be 0 or 1"}},isReadable:function(){return this.get("Meta.status")=="readable"},isWritable:function(){return this.get("Meta.status")=="writable"},isDenied:function(){return this.get("Meta.status")=="denied"}});function f(g){return a.Value.generate(g)}function e(g){return function(h){var i=g+"  ";return i+a.Value.generate(h,i)}}function d(h,g){return a.Value.generate(g)+" -> "+a.Value.generate(h)}function b(g){return function(i,h){var j=g+"  ";return j+a.Value.generate(h,j)+" -> "+a.Value.generate(i,j)}}a.Value.generate=function(h,g){var i=g;if(g!=undefined){g=(g!==true)?g:"";i=g+"  "}if(h!=undefined&&h!=null){if(typeof(h)=="string"){if(c(h,"|err")){return h.slice(0,h.length-4)}else{if(c(h,"|obj")){return h.slice(0,h.length-4)}else{if(c(h,"|int")){return h.slice(0,h.length-4)}else{if(c(h,"|float")){return h.slice(0,h.length-6)}else{if(c(h,"|str")){return JSON.stringify(h.slice(0,h.length-4))}else{return JSON.stringify(h)}}}}}}else{if(_.isArray(h)&&g!=undefined){return"{\n"+_.chain(h).map(e(g)).join(",\n").value()+"\n"+g+"}"}else{if(_.isArray(h)){return"{"+_.chain(h).map(f).join(", ").value()+"}"}else{if(_.isObject(h)&&g!=undefined){return"[\n"+_.chain(h).map(b(g)).join(",\n").value()+"\n"+g+"]"}else{if(_.isObject(h)){return"["+_.chain(h).map(d).join(", ").value()+"]"}}}}}return h.toString()}return undefined};a.Property=a.NestedModel.extend({validate:function(g){if(g&&"Property" in g&&(typeof(g.Property)!="object")){return"invalid property"}if(g&&"Property" in g&&"name" in g.Property&&!a.isString(g.Property.name)){return"invalid property: `name' must be a string"}if(g&&"Property" in g&&"owner" in g.Property&&!a.isObjectNumber(g.Property.owner)){return"invalid property: `owner' must be an object number"}if(g&&"Property" in g&&"perms" in g.Property&&!a.isValidPerms(g.Property.perms,"rwc")){return"invalid property: `perms' must be in the set 'rwc'"}},isReadable:function(){return this.get("Meta.status")=="readable"},isWritable:function(){return this.get("Meta.status")=="writable"},isDenied:function(){return this.get("Meta.status")=="denied"}});a.Verb=a.NestedModel.extend({validate:function(g){if(g&&"Verb" in g&&(typeof(g.Verb)!="object")){return"invalid verb"}if(g&&"Verb" in g&&"names" in g.Verb&&!a.isString(g.Verb.names)){return"invalid verb: `names' must be a string"}if(g&&"Verb" in g&&"owner" in g.Verb&&!a.isObjectNumber(g.Verb.owner)){return"invalid verb: `owner' must be an object number"}if(g&&"Verb" in g&&"perms" in g.Verb&&!a.isValidPerms(g.Verb.perms,"rwxd")){return"invalid verb: `perms' must be in the set 'rwxd'"}if(g&&"Verb" in g&&"dobj" in g.Verb&&!a.isValidObj(g.Verb.dobj)){return"invalid verb: `dobj' must be valid"}if(g&&"Verb" in g&&"prep" in g.Verb&&!a.isValidPrep(g.Verb.prep)){return"invalid verb: `prep' must be valid"}if(g&&"Verb" in g&&"iobj" in g.Verb&&!a.isValidObj(g.Verb.iobj)){return"invalid verb: `iobj' must be valid"}if(g&&"Verb" in g&&"code" in g.Verb&&!a.isValidCode(g.Verb.code)){return"invalid verb: `code' must be an array of strings"}},isReadable:function(){return this.get("Meta.status")=="readable"},isWritable:function(){return this.get("Meta.status")=="writable"},isDenied:function(){return this.get("Meta.status")=="denied"}});a.Collection=Backbone.Collection.extend({add:function(i,h){i=_.isArray(i)?i.slice():[i];var g=this instanceof a.Attributes||this instanceof a.Values;i=_.chain(i).map(function(j){if(!("id" in j)){if(g){return _.map(j,function(m,l){m.id=l;return m})}else{j.id=i.length;return j}}return j}).flatten().value();return Backbone.Collection.prototype.add.call(this,i,h)}});a.Attributes=a.Collection.extend({model:a.Attribute});a.Values=a.Collection.extend({model:a.Value});a.Properties=a.Collection.extend({model:a.Property});a.Verbs=a.Collection.extend({model:a.Verb});a.Object=Backbone.Model.extend({urlRoot:"///objects",initialize:function(){this.attributez=new a.Attributes;this.attributez.url=this.url()+"/attributes";this.values=new a.Values;this.values.url=this.url()+"/values";this.properties=new a.Properties;this.properties.url=this.url()+"/properties";this.verbs=new a.Verbs;this.verbs.url=this.url()+"/verbs";this.parse(this.attributes)},validate:function(g){var h,i;if((h=this.attributez.get("player"))&&!a.isBinary(h.get("Value.value"))){return"invalid attribute: `player' must be 0 or 1"}if((h=this.attributez.get("parents"))&&!a.isValidObjectNumberArray(h.get("Value.value"))){return"invalid attribute: `parents' must be an array of object numbers"}if((i=this.values.get("name"))&&!a.isString(i.get("Value.value"))){return"invalid value: `name' must be a string"}if((i=this.values.get("owner"))&&!a.isObjectNumber(i.get("Value.value"))){return"invalid value: `owner' must be an object number"}if((i=this.values.get("location"))&&!a.isObjectNumber(i.get("Value.value"))){return"invalid value: `location' must be an object number"}if((i=this.values.get("contents"))&&!a.isValidObjectNumberArray(i.get("Value.value"))){return"invalid value: `contents' must be an array of object numbers"}if((i=this.values.get("programmer"))&&!a.isBinary(i.get("Value.value"))){return"invalid value: `programmer' must be 0 or 1"}if((i=this.values.get("wizard"))&&!a.isBinary(i.get("Value.value"))){return"invalid value: `wizard' must be 0 or 1"}if((i=this.values.get("r"))&&!a.isBinary(i.get("Value.value"))){return"invalid value: `r' must be 0 or 1"}if((i=this.values.get("w"))&&!a.isBinary(i.get("Value.value"))){return"invalid value: `w' must be 0 or 1"}if((i=this.values.get("f"))&&!a.isBinary(i.get("Value.value"))){return"invalid value: `f' must be 0 or 1"}},parse:function(h){var l=function(m,o,n){o.id=n;m.push(o);return m};var j=h.Attributes;delete h.Attributes;this.attributez.reset(j);var g=h.Values;delete h.Values;this.values.reset(g);var i=h.Properties;delete h.Properties;this.properties.reset(_.chain(i).reduce(l,[]).value());var k=h.Verbs;delete h.Verbs;this.verbs.reset(_.chain(k).reduce(l,[]).value());if("Meta" in h&&"id" in h.Meta){this.id=h.Meta.id}return h},fetch:function(i){i=i?_.clone(i):{};var h=this;var g=i.error;i.error=function(j,k){j.httpResponseStatus=k.status;if(g){g(j,k)}};return Backbone.Model.prototype.fetch.call(this,i)},failed:function(){return this.httpResponseStatus>=300},isNotFound:function(){return this.httpResponseStatus==404},isDenied:function(){return this.httpResponseStatus==403},isReadable:function(){var g;return(g=this.get("Meta"))&&g.status=="readable"},isWritable:function(){var g;return(g=this.get("Meta"))&&g.status=="writable"},toJSON:function(){var g=function(h,j,i){h[j.id]=j;delete j.id;return h};return{Attributes:_.chain(this.attributez.toJSON()).reduce(g,{}).value(),Values:_.chain(this.values.toJSON()).reduce(g,{}).value(),Properties:this.properties.toJSON(),Verbs:this.verbs.toJSON()}}});a.Objects=Backbone.Collection.extend({model:a.Object,url:"///objects"});$.widget("moo.simpleObjectPanel",{options:{template:null,object:null},_setOption:function(g,h){switch(g){case"object":this.options.object=h;this._render();break;case"template":this.options.template=_.template(h);this._render();break}},_render:function(){if(this.options.object&&this.options.template){this.element.html(this.options.template({object:this.options.object}))}},_modal:{show:function(h,i,g){$("h3",h).text(i);$(".textarea",h).text(g);h.modal("show")},resetSelection:function(){if(window.getSelection){window.getSelection().removeAllRanges()}else{if(document.selection){document.selection.empty()}}}},_create:function(){var g=this;if(!this.options.template){$.get("/html/moo-0.0.3.html",function(h){g.options.template=_.template(h);g._render()})}this.element.on("dblclick","tr.value.readable, tr.value.writable",function(m){var k=g.options.object,j=$(".modal",g.element),h=$(m.target).parents("tr"),i=h.data("id"),l=a.Value.generate(k.values.get(i).get("Value.value"),true);g._modal.show(j,i,l);g._modal.resetSelection()});this.element.on("dblclick","tr.property.readable, tr.property.writable",function(l){var j=g.options.object,i=$(".modal",g.element),h=$(l.target).parents("tr"),n=h.data("id"),k=a.Value.generate(j.properties.get(n).get("Property.value"),true),m=j.properties.get(n).get("Property.name");g._modal.show(i,m,k);g._modal.resetSelection()});this.element.on("dblclick","tr.verb.readable, tr.verb.writable",function(l){var j=g.options.object,i=$(".modal",g.element),h=$(l.target).parents("tr"),n=h.data("id"),k=j.verbs.get(n).get("Verb.code").join("\n"),m=j.verbs.get(n).get("Verb.names");g._modal.show(i,m,k);g._modal.resetSelection()})},_init:function(){this._render()},destroy:function(){this.element.html("")}})})(Moo);